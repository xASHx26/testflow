<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TestFlow â€” Panel</title>
  <link rel="stylesheet" href="styles/theme.css">
  <link rel="stylesheet" href="styles/icons.css">
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/panels.css">
  <link rel="stylesheet" href="styles/inspector.css">
  <link rel="stylesheet" href="styles/testcase.css">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: var(--bg-base);
      color: var(--text-primary);
    }

    /* â”€â”€â”€ Popout Title Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .popout-titlebar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 34px;
      padding: 0 12px;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border-subtle);
      -webkit-app-region: drag;
      user-select: none;
    }

    .popout-titlebar .popout-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }

    .popout-titlebar .popout-actions {
      display: flex;
      gap: 6px;
      -webkit-app-region: no-drag;
    }

    .popout-btn {
      background: none;
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .popout-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--border-strong);
    }

    .popout-btn-dock {
      color: var(--accent-blue);
      border-color: var(--accent-blue);
    }

    .popout-btn-dock:hover {
      background: rgba(137, 180, 250, 0.12);
    }

    /* â”€â”€â”€ Panel Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .popout-content {
      height: calc(100% - 34px);
      overflow: auto;
      display: flex;
      flex-direction: column;
    }

    .popout-content.browser-host { background: #fff; }

    /* â”€â”€â”€ Tab bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .popout-tabs {
      display: flex;
      align-items: center;
      gap: 2px;
      padding: 4px 8px;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border-subtle);
      flex-shrink: 0;
    }

    .popout-tab {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 12px;
      padding: 5px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .popout-tab:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }

    .popout-tab.active {
      color: var(--accent-blue);
      background: rgba(137, 180, 250, 0.1);
    }

    .popout-pane {
      display: none;
      flex: 1;
      overflow: auto;
    }

    .popout-pane.active {
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€â”€ Console renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .po-console { flex:1; overflow-y:auto; padding:4px 8px; font-family:var(--font-mono); font-size:var(--font-size-sm); line-height:1.7; }
    .po-console .entry { display:flex; align-items:flex-start; gap:8px; padding:2px 6px; border-bottom:1px solid var(--bg-surface); }
    .po-console .entry:hover { background:var(--bg-hover); }
    .po-console .time { color:var(--text-dim); font-size:10px; min-width:65px; flex-shrink:0; }
    .po-console .level { font-size:10px; font-weight:600; min-width:50px; flex-shrink:0; text-transform:uppercase; }
    .po-console .level.info    { color:var(--accent-blue); }
    .po-console .level.warning { color:var(--color-warning); }
    .po-console .level.error   { color:var(--color-error); }
    .po-console .level.verbose { color:var(--text-dim); }
    .po-console .level.recorder{ color:var(--accent-mauve); }
    .po-console .level.replay  { color:var(--accent-green); }
    .po-console .msg { color:var(--text-primary); word-break:break-word; flex:1; }

    /* â”€â”€â”€ Network renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .po-network { flex:1; overflow:auto; }
    .po-network table { width:100%; border-collapse:collapse; font-size:var(--font-size-sm); font-family:var(--font-mono); }
    .po-network thead { background:var(--bg-secondary); position:sticky; top:0; }
    .po-network th { padding:6px 8px; text-align:left; color:var(--text-muted); font-weight:600; font-size:10px; text-transform:uppercase; border-bottom:1px solid var(--border-color); }
    .po-network td { padding:4px 8px; color:var(--text-secondary); border-bottom:1px solid var(--bg-surface); max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .po-network tr:hover td { background:var(--bg-hover); }
    .po-network .m-get  { color:var(--color-success); font-weight:600; }
    .po-network .m-post { color:var(--color-warning); font-weight:600; }
    .po-network .s-2xx  { color:var(--color-success); font-weight:600; }
    .po-network .s-3xx  { color:var(--color-warning); font-weight:600; }
    .po-network .s-4xx  { color:var(--color-error); font-weight:600; }
    .po-network .s-5xx  { color:#ef4444; font-weight:600; }

    /* â”€â”€â”€ Inspector renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .po-inspector { flex:1; overflow-y:auto; padding:8px; font-size:var(--font-size-sm); }
    .po-inspector .elem-section { margin-bottom:12px; }
    .po-inspector .elem-label { font-size:10px; font-weight:600; color:var(--text-muted); text-transform:uppercase; margin-bottom:4px; }
    .po-inspector .elem-value { font-family:var(--font-mono); font-size:12px; color:var(--text-primary); padding:4px 8px; background:var(--bg-surface); border-radius:4px; word-break:break-all; }

    /* â”€â”€â”€ Replay log renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .po-replay { flex:1; overflow-y:auto; padding:4px 8px; font-family:var(--font-mono); font-size:var(--font-size-sm); line-height:1.7; }
    .po-replay .rlog-entry { display:flex; align-items:flex-start; gap:8px; padding:2px 6px; border-bottom:1px solid var(--bg-surface); }
    .po-replay .rlog-icon { font-size:12px; }
    .po-replay .rlog-msg  { color:var(--text-primary); flex:1; }
    .rlog-pass .rlog-msg   { color:var(--color-success); }
    .rlog-fail .rlog-msg   { color:var(--color-error); }

    /* â”€â”€â”€ Empty / waiting state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .po-empty { display:flex; align-items:center; justify-content:center; flex:1; color:var(--text-muted); font-size:13px; text-align:center; padding:20px; }
    .po-empty .ei { font-size:28px; margin-bottom:8px; }
    .po-empty .eh { font-size:11px; color:var(--text-dim); margin-top:6px; }

    /* â”€â”€â”€ Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .po-badge { background:var(--accent-blue); color:#fff; font-size:9px; font-weight:700; padding:1px 5px; border-radius:8px; margin-left:4px; }
  </style>
</head>
<body>
  <div class="popout-titlebar">
    <span class="popout-title" id="popout-title">Panel</span>
    <div class="popout-actions">
      <button class="popout-btn popout-btn-dock" id="btn-dock" title="Dock back into main window">â¬… Dock</button>
    </div>
  </div>
  <div class="popout-content" id="popout-content"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const panelType = params.get('panel') || 'unknown';
    const titleEl = document.getElementById('popout-title');
    const contentEl = document.getElementById('popout-content');

    /* â”€â”€ Title config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const titles = {
      browser:      'Browser View',
      flows:        'Test Flows',
      inspector:    'Element Inspector',
      testdata:     'Test Data',
      console:      'Console',
      network:      'Network',
      'replay-log': 'Replay Log',
      'bottom-all': 'Console Â· Network Â· Replay Log',
      'right-all':  'Inspector Â· Test Data',
    };

    titleEl.textContent = titles[panelType] || 'Panel';
    document.title = `TestFlow â€” ${titles[panelType] || 'Panel'}`;

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     *  BUILD LIVE CONTENT PER PANEL TYPE
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function buildContent() {
      /* â”€â”€ Browser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      if (panelType === 'browser') {
        contentEl.classList.add('browser-host');
        contentEl.innerHTML = `<div class="po-empty"><div><div class="ei">ğŸŒ</div>
          <div>Browser view is now on this window</div>
          <div class="eh">The embedded browser has been moved here.<br>Click <strong>Dock</strong> to return it.</div></div></div>`;
        return;
      }

      /* â”€â”€ Flows / Test Data (no live stream) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      if (panelType === 'flows') {
        contentEl.innerHTML = `<div class="po-empty"><div><div class="ei">ğŸ“‚</div>
          <div>Test Flows panel detached</div>
          <div class="eh">Flows and steps are managed in the main IDE.<br>Click <strong>Dock</strong> to return.</div></div></div>`;
        return;
      }
      if (panelType === 'testdata') {
        contentEl.innerHTML = `<div class="po-empty"><div><div class="ei">ğŸ“Š</div>
          <div>Test Data panel detached</div>
          <div class="eh">Test data is managed in the main IDE.<br>Click <strong>Dock</strong> to return.</div></div></div>`;
        return;
      }

      /* â”€â”€ Console (live) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      if (panelType === 'console') {
        contentEl.innerHTML = `<div class="po-console" id="live-console">
          <div class="po-empty" id="console-empty"><div><div class="ei">ğŸ“‹</div><div>Waiting for console outputâ€¦</div></div></div></div>`;
        setupConsoleListener();
        return;
      }

      /* â”€â”€ Network (live) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      if (panelType === 'network') {
        contentEl.innerHTML = `<div class="po-network" id="live-network">
          <table><thead><tr><th>Method</th><th>URL</th><th>Status</th><th>Type</th><th>Size</th><th>Time</th></tr></thead>
          <tbody id="net-body"></tbody></table>
          <div class="po-empty" id="network-empty"><div><div class="ei">ğŸŒ</div><div>Waiting for network requestsâ€¦</div></div></div></div>`;
        setupNetworkListener();
        return;
      }

      /* â”€â”€ Replay Log (live) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      if (panelType === 'replay-log') {
        contentEl.innerHTML = `<div class="po-replay" id="live-replay">
          <div class="po-empty" id="replay-empty"><div><div class="ei">â–¶ï¸</div><div>Waiting for replay eventsâ€¦</div></div></div></div>`;
        setupReplayListener();
        return;
      }

      /* â”€â”€ Inspector (live) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      if (panelType === 'inspector') {
        contentEl.innerHTML = `<div class="po-inspector" id="live-inspector">
          <div class="po-empty" id="inspector-empty"><div><div class="ei">ğŸ”</div><div>Enable the Inspector and hover over elementsâ€¦</div></div></div></div>`;
        setupInspectorListener();
        return;
      }

      /* â”€â”€ Right-All (Inspector + Test Data) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      if (panelType === 'right-all') {
        contentEl.innerHTML = `
          <div class="popout-tabs">
            <button class="popout-tab active" data-pane="rinsp">Inspector</button>
            <button class="popout-tab" data-pane="rtd">Test Data</button>
          </div>
          <div class="popout-pane active" id="pane-rinsp">
            <div class="po-inspector" id="live-inspector">
              <div class="po-empty" id="inspector-empty"><div><div class="ei">ğŸ”</div><div>Enable the Inspector and hover over elementsâ€¦</div></div></div></div>
          </div>
          <div class="popout-pane" id="pane-rtd">
            <div class="po-empty"><div><div class="ei">ğŸ“Š</div><div>Test data is managed in the main IDE.</div></div></div>
          </div>`;
        setupTabs();
        setupInspectorListener();
        return;
      }

      /* â”€â”€ Bottom-All (Console + Network + Replay) â”€â”€â”€â”€â”€â”€â”€ */
      if (panelType === 'bottom-all') {
        contentEl.innerHTML = `
          <div class="popout-tabs">
            <button class="popout-tab active" data-pane="bcon">Console<span class="po-badge" id="badge-console" style="display:none">0</span></button>
            <button class="popout-tab" data-pane="bnet">Network<span class="po-badge" id="badge-network" style="display:none">0</span></button>
            <button class="popout-tab" data-pane="brep">Replay Log</button>
          </div>
          <div class="popout-pane active" id="pane-bcon">
            <div class="po-console" id="live-console">
              <div class="po-empty" id="console-empty"><div><div class="ei">ğŸ“‹</div><div>Waiting for console outputâ€¦</div></div></div></div>
          </div>
          <div class="popout-pane" id="pane-bnet">
            <div class="po-network" id="live-network">
              <table><thead><tr><th>Method</th><th>URL</th><th>Status</th><th>Type</th><th>Size</th><th>Time</th></tr></thead>
              <tbody id="net-body"></tbody></table>
              <div class="po-empty" id="network-empty"><div><div class="ei">ğŸŒ</div><div>Waiting for network requestsâ€¦</div></div></div></div>
          </div>
          <div class="popout-pane" id="pane-brep">
            <div class="po-replay" id="live-replay">
              <div class="po-empty" id="replay-empty"><div><div class="ei">â–¶ï¸</div><div>Waiting for replay eventsâ€¦</div></div></div></div>
          </div>`;
        setupTabs();
        setupConsoleListener();
        setupNetworkListener();
        setupReplayListener();
        return;
      }

      /* â”€â”€ Fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      contentEl.innerHTML = `<div class="po-empty"><div><div class="ei">ğŸ“Œ</div>
        <div>Panel detached</div>
        <div class="eh">Click <strong>Dock</strong> to return it to the main IDE.</div></div></div>`;
    }

    /* â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function setupTabs() {
      contentEl.querySelectorAll('.popout-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          contentEl.querySelectorAll('.popout-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          contentEl.querySelectorAll('.popout-pane').forEach(p => p.classList.remove('active'));
          const pane = document.getElementById('pane-' + tab.dataset.pane);
          if (pane) pane.classList.add('active');
        });
      });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     *  LIVE EVENT LISTENERS
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /* â”€â”€ Console â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function setupConsoleListener() {
      const container = document.getElementById('live-console');
      const empty = document.getElementById('console-empty');
      const badge = document.getElementById('badge-console');
      let count = 0;

      window.popoutApi.on('console:log', (data) => {
        if (empty) empty.style.display = 'none';
        count++;
        if (badge) { badge.style.display = ''; badge.textContent = count; }

        const entry = document.createElement('div');
        entry.className = 'entry';
        const ts = new Date(data.timestamp || Date.now());
        const time = ts.toLocaleTimeString('en', { hour12: false });
        entry.innerHTML = `<span class="time">${time}</span>` +
          `<span class="level ${data.level || 'info'}">${data.level || 'info'}</span>` +
          `<span class="msg">${escHtml(data.message || data.text || JSON.stringify(data.args || data))}</span>`;
        container.appendChild(entry);
        container.scrollTop = container.scrollHeight;
      });
    }

    /* â”€â”€ Network â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function setupNetworkListener() {
      const tbody = document.getElementById('net-body');
      const empty = document.getElementById('network-empty');
      const badge = document.getElementById('badge-network');
      let count = 0;

      window.popoutApi.on('network:request', (data) => {
        if (empty) empty.style.display = 'none';
        count++;
        if (badge) { badge.style.display = ''; badge.textContent = count; }

        const m = (data.method || 'GET').toUpperCase();
        const s = data.statusCode || data.status || 0;
        const sc = s >= 500 ? 's-5xx' : s >= 400 ? 's-4xx' : s >= 300 ? 's-3xx' : s >= 200 ? 's-2xx' : '';
        const mc = m === 'GET' ? 'm-get' : m === 'POST' ? 'm-post' : '';
        const dur = data.duration || data.time || '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="${mc}">${m}</td>` +
          `<td title="${escHtml(data.url || '')}">${escHtml(truncUrl(data.url || ''))}</td>` +
          `<td class="${sc}">${data.error ? 'ERR' : (s || 'â€”')}</td>` +
          `<td>${escHtml(data.resourceType || data.type || '')}</td>` +
          `<td>${fmtSize(data.size)}</td>` +
          `<td>${dur ? dur + 'ms' : 'â€”'}</td>`;
        tbody.appendChild(tr);
      });

      window.popoutApi.on('network:clear', () => {
        if (tbody) tbody.innerHTML = '';
        if (empty) empty.style.display = '';
        count = 0;
        if (badge) { badge.style.display = 'none'; badge.textContent = '0'; }
      });
    }

    /* â”€â”€ Inspector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function setupInspectorListener() {
      const container = document.getElementById('live-inspector');
      const empty = document.getElementById('inspector-empty');

      function render(data) {
        if (!data) return;
        if (empty) empty.style.display = 'none';
        let h = '';

        // Element tag â€” data uses "tag" (not "tagName") and "classes" (array)
        const tag = data.tag || data.tagName || '';
        const cls = Array.isArray(data.classes) ? data.classes.join(' ') : (data.className || data.classes || '');
        if (tag) {
          h += `<div class="elem-section"><div class="elem-label">Element</div>
            <div class="elem-value">&lt;${escHtml(tag)}${data.id ? ' id="'+escHtml(data.id)+'"' : ''}${cls ? ' class="'+escHtml(cls)+'"' : ''}&gt;</div></div>`;
        }

        // Text content
        const txt = data.text || data.innerText || '';
        if (txt) {
          h += `<div class="elem-section"><div class="elem-label">Text</div>
            <div class="elem-value">${escHtml(txt.substring(0, 200))}</div></div>`;
        }

        // Type / Name / Value
        if (data.type)  h += sec('Type', data.type);
        if (data.name)  h += sec('Name', data.name);
        if (data.value) h += sec('Value', data.value);
        if (data.href)  h += sec('Href', data.href);

        // XPath
        if (data.xpath) h += sec('XPath', data.xpath);
        if (data.absoluteXpath) h += sec('Absolute XPath', data.absoluteXpath);

        // CSS Selector
        if (data.cssSelector) h += sec('CSS Selector', data.cssSelector);

        // Aria
        if (data.ariaLabel) h += sec('ARIA Label', data.ariaLabel);
        if (data.ariaRole)  h += sec('ARIA Role', data.ariaRole);

        // Test IDs
        if (data['data-testid'])       h += sec('data-testid', data['data-testid']);
        if (data['data-cy'])           h += sec('data-cy', data['data-cy']);
        if (data['data-test'])         h += sec('data-test', data['data-test']);
        if (data['data-automation-id'])h += sec('data-automation-id', data['data-automation-id']);

        // All attributes
        if (data.attributes && Object.keys(data.attributes).length) {
          h += `<div class="elem-section"><div class="elem-label">All Attributes</div>`;
          for (const [k, v] of Object.entries(data.attributes))
            h += `<div class="elem-value" style="margin-bottom:2px"><strong>${escHtml(k)}</strong>: ${escHtml(v)}</div>`;
          h += `</div>`;
        }

        // Dimensions
        if (data.rect) {
          h += `<div class="elem-section"><div class="elem-label">Position &amp; Size</div>
            <div class="elem-value">${data.rect.width}Ã—${data.rect.height} at (${data.rect.x}, ${data.rect.y})</div></div>`;
        }

        container.innerHTML = h || '<div class="po-empty"><div>No element data</div></div>';
      }

      function sec(label, val) {
        return `<div class="elem-section"><div class="elem-label">${escHtml(label)}</div><div class="elem-value">${escHtml(String(val))}</div></div>`;
      }

      window.popoutApi.on('inspector:element-hovered',  (d) => render(d));
      window.popoutApi.on('inspector:element-selected', (d) => render(d));
    }

    /* â”€â”€ Replay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function setupReplayListener() {
      const container = document.getElementById('live-replay');
      const empty = document.getElementById('replay-empty');

      function add(icon, msg, cls) {
        if (empty) empty.style.display = 'none';
        const div = document.createElement('div');
        div.className = `rlog-entry ${cls || ''}`;
        div.innerHTML = `<span class="rlog-icon">${icon}</span><span class="rlog-msg">${escHtml(msg)}</span>`;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
      }

      window.popoutApi.on('replay:started', (d) => {
        add('â–¶ï¸', `Replay started${d?.flowName ? ': ' + d.flowName : ''}`, '');
      });
      window.popoutApi.on('replay:step-started', (d) => {
        add('â³', `Step ${d?.index !== undefined ? d.index + 1 : '?'}: ${d?.action || d?.type || 'running'}â€¦`, '');
      });
      window.popoutApi.on('replay:step-completed', (d) => {
        const ok = d?.success !== false;
        add(ok ? 'âœ…' : 'âŒ', `Step ${d?.index !== undefined ? d.index + 1 : '?'}: ${ok ? 'passed' : 'failed'}${d?.error ? ' â€” ' + d.error : ''}`, ok ? 'rlog-pass' : 'rlog-fail');
      });
      window.popoutApi.on('replay:finished', (d) => {
        add('ğŸ', `Replay finished â€” ${d?.passed || 0} passed, ${d?.failed || 0} failed`, '');
      });
      window.popoutApi.on('replay:error', (d) => {
        add('ğŸš¨', `Error: ${d?.message || d?.error || 'Unknown'}`, 'rlog-fail');
      });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     *  HELPERS
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function escHtml(s) { const el = document.createElement('span'); el.textContent = s; return el.innerHTML; }
    function truncUrl(u) { try { const p = new URL(u); return p.pathname + p.search; } catch (_) { return u.length > 60 ? u.substring(0, 57) + 'â€¦' : u; } }
    function fmtSize(b) { if (!b && b !== 0) return ''; if (b < 1024) return b + 'B'; if (b < 1048576) return (b/1024).toFixed(1) + 'KB'; return (b/1048576).toFixed(1) + 'MB'; }

    /* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    buildContent();
    document.getElementById('btn-dock').addEventListener('click', () => {
      if (window.popoutApi) window.popoutApi.dock();
    });
  </script>
</body>
</html>
